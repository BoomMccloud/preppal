syntax = "proto3";

package preppal;

// =============================================
// Sent from Client to Server
// =============================================

message ClientToServerMessage {
  oneof payload {
    AudioChunk audio_chunk = 1;
    EndRequest end_request = 2;
  }
}

// Contains a chunk of raw audio data from the client's microphone.
message AudioChunk {
  bytes audio_content = 1; // 16-bit LINEAR_PCM, 16kHz, mono
}

// Sent when the user clicks the "End Interview" button.
message EndRequest {}


// =============================================
// Sent from Server to Client
// =============================================

message ServerToClientMessage {
  oneof payload {
    TranscriptUpdate transcript_update = 1;
    AudioResponse audio_response = 2;
    ErrorResponse error = 3;
    SessionEnded session_ended = 4;
  }
}

// Contains a segment of transcribed text from the user or AI.
message TranscriptUpdate {
  string speaker = 1; // "USER" or "AI"
  string text = 2;
  bool is_final = 3; // True if this is a final, corrected transcript segment
  bool turn_complete = 4; // True if the turn is complete
}

// Contains a chunk of AI-generated audio data to be played by the client.
message AudioResponse {
  bytes audio_content = 1; // 16-bit LINEAR_PCM, 16kHz, mono
}

// Sent when a recoverable or fatal error occurs.
message ErrorResponse {
  int32 code = 1;       // e.g., 4001 (Auth Error), 4002 (Gemini API Error)
  string message = 2; // "An internal error occurred."
}

// Notifies the client that the session has definitively ended.
message SessionEnded {
  enum Reason {
    REASON_UNSPECIFIED = 0;
    USER_INITIATED = 1; // User clicked "End"
    GEMINI_ENDED = 2;   // AI concluded the interview
    TIMEOUT = 3;        // Session hit 1-hour limit
  }
  Reason reason = 1;
}


// =============================================
// Worker to API Communication (HTTP/Protobuf)
// =============================================

// Wrapper message for all worker-to-API requests
message WorkerApiRequest {
  oneof request {
    GetContextRequest get_context = 1;
    UpdateStatusRequest update_status = 2;
    SubmitTranscriptRequest submit_transcript = 3;
    SubmitFeedbackRequest submit_feedback = 4;
  }
}

// Wrapper message for all worker-to-API responses
message WorkerApiResponse {
  oneof response {
    GetContextResponse get_context = 1;
    UpdateStatusResponse update_status = 2;
    SubmitTranscriptResponse submit_transcript = 3;
    SubmitFeedbackResponse submit_feedback = 4;
    ApiError error = 5;
  }
}

// ---- getContext ----
message GetContextRequest {
  string interview_id = 1;
}

message GetContextResponse {
  string job_description = 1;
  string resume = 2;
  string persona = 3;
  int32 duration_ms = 4; // Interview duration in milliseconds
}

// ---- updateStatus ----
message UpdateStatusRequest {
  string interview_id = 1;
  InterviewStatus status = 2;
  string ended_at = 3; // Optional ISO 8601 timestamp
}

enum InterviewStatus {
  STATUS_UNSPECIFIED = 0;
  IN_PROGRESS = 1;
  COMPLETED = 2;
  ERROR = 3;
}

message UpdateStatusResponse {
  bool success = 1;
}

// ---- submitTranscript ----
message SubmitTranscriptRequest {
  string interview_id = 1;
  bytes transcript = 2;  // Protobuf binary blob (preppal.transcript.Transcript)
  string ended_at = 3;   // ISO 8601 timestamp
}

message SubmitTranscriptResponse {
  bool success = 1;
}

// ---- submitFeedback ----
message SubmitFeedbackRequest {
  string interview_id = 1;
  string summary = 2;
  string strengths = 3;
  string content_and_structure = 4;
  string communication_and_delivery = 5;
  string presentation = 6;
}

message SubmitFeedbackResponse {
  bool success = 1;
}

// ---- Error Handling ----
message ApiError {
  int32 code = 1;     // HTTP-like status codes: 400, 401, 404, 500
  string message = 2;
}

# Task: Refactor JWT Dependencies and Cleanup

## Problem
The project currently uses two different libraries for handling JSON Web Tokens (JWTs), which leads to redundancy, potential inconsistencies, and increased bundle size.

1.  **`jose`**: Used in the Cloudflare Worker (`worker/src/auth.ts`) because it is compatible with the Edge runtime. It is also used in `src/server/api/routers/interview.ts` for `generateWsToken`.
2.  **`jsonwebtoken`**: Used solely in `src/server/api/routers/interview.ts` for the `generateWorkerToken` function. This library is Node.js specific and not Edge-compatible.

## Goal
Standardize on `jose` for all JWT operations across the project (Next.js backend and Cloudflare Worker). This will allow for the removal of `jsonwebtoken` and its types, reducing dependencies and ensuring consistent cryptographic implementation.

## Plan

### 1. Refactor `generateWorkerToken`
Modify `src/server/api/routers/interview.ts` to use `jose` instead of `jsonwebtoken`.

**Current Implementation (using `jsonwebtoken`):**
```typescript
import jwt from "jsonwebtoken";

const generateWorkerToken = (payload: object) => {
  return jwt.sign(payload, process.env.WORKER_SHARED_SECRET!);
};
```

**Target Implementation (using `jose`):**
```typescript
import * as jose from "jose";

const generateWorkerToken = async (payload: object) => {
  const secret = new TextEncoder().encode(process.env.WORKER_SHARED_SECRET!);
  return await new jose.SignJWT(payload as any)
    .setProtectedHeader({ alg: 'HS256' })
    .sign(secret);
};
```
*Note: The `jose` implementation is asynchronous, so the calling code in the tRPC router procedures must be updated to `await` the result.*

### 2. Update Callsites
Identify and update all usages of `generateWorkerToken` within `src/server/api/routers/interview.ts` (and anywhere else it might be used) to handle the returned `Promise`.

### 3. Verify Functionality
Run existing tests to ensure that the token generation still works correctly and that the Cloudflare Worker can still verify the tokens generated by the new implementation.

*   Run `pnpm test worker` to verify the worker can still accept requests (if integration tests exist).
*   Run `pnpm test` to run backend tests.

### 4. Remove Dependencies
Once the refactor is verified, remove the unused packages.

```bash
pnpm remove jsonwebtoken @types/jsonwebtoken
```

## Status
- [ ] Refactor `generateWorkerToken` in `src/server/api/routers/interview.ts` to use `jose`.
- [ ] Update all callsites of `generateWorkerToken` to await the result.
- [ ] Verify functionality with tests.
- [ ] Remove `jsonwebtoken` and `@types/jsonwebtoken` from `package.json`.
